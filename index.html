<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠåˆ†å¸³ç¥å™¨ V3 (çµç®—ç‰ˆ)</title>
    <style>
        /* --- åŸºç¤æ¨£å¼ --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; margin: 0; padding: 0; color: #333; }
        .container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: #fff; position: relative; padding-bottom: 80px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        /* --- å°èˆªåˆ— --- */
        header { background: #2196F3; color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; }
        header h2 { margin: 0; font-size: 18px; }
        .header-btn { background: none; border: none; color: white; font-size: 14px; cursor: pointer; }

        /* --- é é¢æ§åˆ¶ --- */
        .view-section { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- å¡ç‰‡èˆ‡å…ƒä»¶ --- */
        .card { background: white; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card h4 { margin-top: 0; margin-bottom: 10px; color: #555; }
        
        input, select, button { width: 100%; box-sizing: border-box; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        button { cursor: pointer; border: none; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: #2196F3; color: white; }
        .btn-danger { background: #ff5722; color: white; }
        .btn-success { background: #4caf50; color: white; }
        .btn-outline { background: transparent; border: 1px solid #2196F3; color: #2196F3; }

        /* --- åˆ—è¡¨æ¨£å¼ --- */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f0f0f0; }
        .list-item:last-child { border-bottom: none; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white; margin-left: 5px; }
        .bg-cash { background: #4caf50; }
        .bg-card { background: #ff9800; }

        /* --- çµç®—æ¨£å¼ (æ–°) --- */
        .debt-card { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-radius: 8px; margin-bottom: 10px; color: white; }
        .debt-owe { background-color: #ff5252; } /* æˆ‘æ¬ äºº */
        .debt-get { background-color: #4caf50; } /* äººæ¬ æˆ‘ */
        .debt-even { background-color: #9e9e9e; } /* æŒå¹³ */
        .debt-amount { font-size: 20px; font-weight: bold; }

        /* --- åº•éƒ¨å°èˆª --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 10px 0; max-width: 600px; margin: 0 auto; }
        .nav-item { border: none; background: none; font-size: 12px; color: #888; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: #2196F3; font-weight: bold; }
        .nav-icon { font-size: 20px; margin-bottom: 2px; }

        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .checkbox-label { background: #f0f0f0; padding: 8px 12px; border-radius: 20px; display: flex; align-items: center; cursor: pointer; }
        .checkbox-label input { width: auto; margin: 0 5px 0 0; }
        .empty-state { text-align: center; color: #999; margin-top: 30px; }
    </style>
</head>
<body>

<div class="container">
    <header id="app-header">
        <h2 id="page-title">æ—…è²»åˆ†å¸³</h2>
    </header>

    <div id="view-login" class="view-section active">
        <div style="text-align: center; margin-top: 50px;">
            <h1>âœˆï¸</h1>
            <h2>æ­¡è¿ä½¿ç”¨åˆ†å¸³ç¥å™¨ V3</h2>
            <button id="btn-login" class="btn-primary">Google å¸³è™Ÿç™»å…¥</button>
        </div>
    </div>

    <div id="view-profile" class="view-section">
        <div class="card">
            <h4>ğŸ‘‹ è¨­å®šæš±ç¨±</h4>
            <input type="text" id="profile-name-input" placeholder="ä¾‹å¦‚ï¼šå¸¥æ°£å°æ˜">
            <button id="btn-save-profile" class="btn-primary">å„²å­˜ä¸¦é–‹å§‹</button>
        </div>
    </div>

    <div id="view-groups" class="view-section">
        <div class="card">
            <h4>å»ºç«‹æ–°è¡Œç¨‹</h4>
            <input type="text" id="new-group-name" placeholder="åç¨± (ä¾‹: æ—¥æœ¬è¡Œ)">
            <button id="btn-create-group" class="btn-primary">å»ºç«‹</button>
        </div>
        <div class="card">
            <h4>åŠ å…¥è¡Œç¨‹</h4>
            <input type="text" id="join-group-id" placeholder="ç¾¤çµ„ ID">
            <button id="btn-join-group" class="btn-outline">åŠ å…¥</button>
        </div>
        <h4 style="margin: 20px 0 10px;">æˆ‘çš„ç¾¤çµ„</h4>
        <div id="my-groups-list"></div>
    </div>

    <div id="view-dashboard" class="view-section">
        
        <div id="tab-add" class="tab-content">
            <div class="card">
                <label>é‡‘é¡</label>
                <input type="number" id="expense-amount" placeholder="0">
                <label>é …ç›®</label>
                <input type="text" id="expense-note" placeholder="ä¾‹å¦‚ï¼šåˆé¤">
                <div style="display: flex; gap: 10px;">
                    <div style="flex:1">
                        <label>æ–¹å¼</label>
                        <select id="expense-method">
                            <option value="cash">ğŸ’µ ç¾é‡‘</option>
                            <option value="card">ğŸ’³ åˆ·å¡</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label>ä»˜æ¬¾äºº</label>
                        <select id="payer-select"></select>
                    </div>
                </div>
                <label>åˆ†æ“”äºº</label>
                <div id="split-members-container" class="checkbox-group"></div>
                <br>
                <button id="btn-submit-expense" class="btn-primary">ç¢ºèªè¨˜å¸³</button>
            </div>
            
            <div class="card">
                <h4>ğŸ“œ æœ€è¿‘å¸³ç›® (å…¨é«”)</h4>
                <div id="recent-list"></div>
            </div>
        </div>

        <div id="tab-settle" class="tab-content" style="display: none;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h3>çµç®—ä¸­å¿ƒ</h3>
                <p style="color: #666; font-size: 14px;">ç³»çµ±æœƒè‡ªå‹•è¨ˆç®—äº’ç›¸æŠµéŠ·å¾Œçš„é‡‘é¡<br>é»æ“Šä¸‹æ–¹å¡ç‰‡å³å¯é€²è¡Œã€Œçµæ¸…ã€</p>
            </div>
            <div id="settlement-list">
                </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('tab-add', this)">
                <span class="nav-icon">â•</span>è¨˜å¸³
            </button>
            <button class="nav-item" onclick="switchTab('tab-settle', this)">
                <span class="nav-icon">ğŸ’°</span>çµç®—
            </button>
            <button class="nav-item" onclick="goBackToGroups()">
                <span class="nav-icon">ğŸ”™</span>æ›åœ˜
            </button>
        </div>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, getDoc, setDoc, updateDoc, arrayUnion, onSnapshot, query, where, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // âš ï¸âš ï¸âš ï¸ è«‹åœ¨æ­¤æ›¿æ›ä½ çš„ Firebase Config âš ï¸âš ï¸âš ï¸
    const firebaseConfig = {
        apiKey: "AIzaSyDQFDcA3OB0y-KZCDf9QzQLFZm8w3oVqyg",
        authDomain: "trip-web-82474.firebaseapp.com",
        projectId: "trip-web-82474",
        storageBucket: "trip-web-82474.firebasestorage.app",
        messagingSenderId: "900625161560",
        appId: "1:900625161560:web:370f4dcb647f44fc1c992d",
        measurementId: "G-PHVPTW4CPL"
        };


    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentGroupId = null;
    let currentGroupMembers = [];
    let allExpensesCache = []; // ç”¨ä¾†æš«å­˜è³‡æ–™ä»¥è¨ˆç®—å‚µå‹™

    // --- ä»‹é¢åˆ‡æ› ---
    function showView(viewId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
    }

    window.switchTab = (tabId, btnElement) => {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.getElementById(tabId).style.display = 'block';
        document.querySelectorAll('.bottom-nav .nav-item').forEach(btn => btn.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');
        
        // å¦‚æœåˆ‡æ›åˆ°çµç®—é é¢ï¼Œé‡æ–°è¨ˆç®—
        if(tabId === 'tab-settle') calculateDebts();
    };

    window.goBackToGroups = () => {
        currentGroupId = null;
        showView('view-groups');
    };

    // --- ç™»å…¥èˆ‡åˆå§‹åŒ– ---
    document.getElementById('btn-login').addEventListener('click', () => {
        signInWithPopup(auth, new GoogleAuthProvider()).catch(alert);
    });

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists() && userDoc.data().displayName) {
                currentUser.displayName = userDoc.data().displayName;
                loadMyGroups();
                showView('view-groups');
            } else {
                showView('view-profile');
            }
        } else {
            showView('view-login');
        }
    });

    document.getElementById('btn-save-profile').addEventListener('click', async () => {
        const name = document.getElementById('profile-name-input').value.trim();
        if (!name) return;
        await setDoc(doc(db, "users", currentUser.uid), { displayName: name, email: currentUser.email }, { merge: true });
        currentUser.displayName = name;
        loadMyGroups();
        showView('view-groups');
    });

    // --- ç¾¤çµ„æ“ä½œ ---
    document.getElementById('btn-create-group').addEventListener('click', async () => {
        const name = document.getElementById('new-group-name').value.trim();
        if (!name) return;
        const docRef = await addDoc(collection(db, "groups"), {
            name: name,
            members: [{ uid: currentUser.uid, name: currentUser.displayName }],
            createdAt: new Date()
        });
        alert(`å»ºç«‹æˆåŠŸï¼ID: ${docRef.id}`);
        loadMyGroups();
    });

    document.getElementById('btn-join-group').addEventListener('click', async () => {
        const groupId = document.getElementById('join-group-id').value.trim();
        if (!groupId) return;
        const groupRef = doc(db, "groups", groupId);
        const snap = await getDoc(groupRef);
        if (snap.exists()) {
            const members = snap.data().members || [];
            if (!members.some(m => m.uid === currentUser.uid)) {
                await updateDoc(groupRef, { members: arrayUnion({ uid: currentUser.uid, name: currentUser.displayName }) });
            }
            loadMyGroups();
        } else { alert('æ‰¾ä¸åˆ°ç¾¤çµ„'); }
    });

    async function loadMyGroups() {
        const list = document.getElementById('my-groups-list');
        list.innerHTML = 'è¼‰å…¥ä¸­...';
        const q = query(collection(db, "groups"), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);
        list.innerHTML = '';
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            if (data.members.some(m => m.uid === currentUser.uid)) {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `<strong>${data.name}</strong> <br> <small>ID: ${doc.id}</small>`;
                div.onclick = () => enterGroup(doc.id, data.name);
                list.appendChild(div);
            }
        });
    }

    // --- é€²å…¥ç¾¤çµ„é‚è¼¯ ---
    function enterGroup(groupId, groupName) {
        currentGroupId = groupId;
        document.getElementById('page-title').innerText = groupName;
        showView('view-dashboard');
        switchTab('tab-add');

        // 1. ç›£è½æˆå“¡
        onSnapshot(doc(db, "groups", groupId), (docSnap) => {
            if(docSnap.exists()) {
                currentGroupMembers = docSnap.data().members;
                renderExpenseForm(currentGroupMembers);
            }
        });

        // 2. ç›£è½å¸³ç›® (è«‹ç¢ºä¿å·²å»ºç«‹ç´¢å¼•)
        const expenseQ = query(collection(db, "expenses"), where("groupId", "==", groupId), orderBy("timestamp", "desc"));
        onSnapshot(expenseQ, (snapshot) => {
            allExpensesCache = []; // æ¸…ç©ºå¿«å–
            const list = document.getElementById('recent-list');
            list.innerHTML = '';

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                data.id = docSnap.id; // è£œä¸Š ID æ–¹ä¾¿æ“ä½œ
                allExpensesCache.push(data); // å­˜å…¥å¿«å–ä¾›çµç®—ä½¿ç”¨

                // é¡¯ç¤ºåˆ—è¡¨
                const payerName = currentGroupMembers.find(m => m.uid === data.payer)?.name || 'æœªçŸ¥';
                const dateStr = data.timestamp?.seconds ? new Date(data.timestamp.seconds * 1000).toLocaleDateString() : '';
                
                // æª¢æŸ¥æˆ‘è‡ªå·±æ˜¯å¦åœ¨é€™ç­†å¸³å–®ä¸”å·²çµæ¸…
                const amIInvolved = data.splitBy.includes(currentUser.uid);
                const amISettled = data.settledMembers ? data.settledMembers.includes(currentUser.uid) : false;
                
                let statusHtml = '';
                if (amIInvolved && data.payer !== currentUser.uid) {
                    statusHtml = amISettled ? '<span style="color:green; font-size:12px;">(å·²ä»˜)</span>' : '<span style="color:red; font-size:12px;">(æœªä»˜)</span>';
                }

                list.innerHTML += `
                    <div class="list-item">
                        <div>
                            <strong>${data.note}</strong> ${statusHtml} <br>
                            <small>${payerName} å…ˆä»˜ $${data.amount}</small>
                        </div>
                        <div style="font-weight:bold;">$${data.amount}</div>
                    </div>`;
            });
            
            // å¦‚æœç•¶å‰åœ¨çµç®—é ï¼Œå³æ™‚æ›´æ–°æ•¸æ“š
            if(document.getElementById('tab-settle').style.display === 'block') {
                calculateDebts();
            }
        });
    }

    function renderExpenseForm(members) {
        const payerSelect = document.getElementById('payer-select');
        const splitContainer = document.getElementById('split-members-container');
        payerSelect.innerHTML = '';
        splitContainer.innerHTML = '';
        members.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.uid;
            opt.innerText = m.name;
            if(m.uid === currentUser.uid) opt.selected = true;
            payerSelect.appendChild(opt);

            const label = document.createElement('label');
            label.className = 'checkbox-label';
            label.innerHTML = `<input type="checkbox" value="${m.uid}" checked> ${m.name}`;
            splitContainer.appendChild(label);
        });
    }

    // --- è¨˜å¸³é‚è¼¯ (è³‡æ–™çµæ§‹æ›´æ–°) ---
    document.getElementById('btn-submit-expense').addEventListener('click', async () => {
        const amount = Number(document.getElementById('expense-amount').value);
        const note = document.getElementById('expense-note').value;
        const method = document.getElementById('expense-method').value;
        const payer = document.getElementById('payer-select').value;
        const checkboxes = document.querySelectorAll('#split-members-container input:checked');
        const splitBy = Array.from(checkboxes).map(cb => cb.value);

        if(!amount || !note || splitBy.length === 0) return alert('è«‹å¡«å¯«å®Œæ•´');

        await addDoc(collection(db, "expenses"), {
            groupId: currentGroupId,
            amount, note, method, payer, splitBy,
            settledMembers: [], // ğŸŒŸ é—œéµæ”¹è®Šï¼šç”¨é™£åˆ—å­˜èª°é‚„éŒ¢äº†
            timestamp: new Date()
        });
        
        document.getElementById('expense-amount').value = '';
        document.getElementById('expense-note').value = '';
        alert('è¨˜å¸³æˆåŠŸï¼');
    });

    // --- ğŸŒŸ æ ¸å¿ƒæ¼”ç®—æ³•ï¼šè¨ˆç®—å‚µå‹™èˆ‡çµæ¸… ---
    function calculateDebts() {
        // 1. å»ºç«‹å‚µå‹™çŸ©é™£ { 'uidA': { 'uidB': 100 } } => A æ¬  B 100 å…ƒ
        let debts = {};

        // åˆå§‹åŒ–
        currentGroupMembers.forEach(m => debts[m.uid] = {});

        // 2. éæ­·æ‰€æœ‰å¸³ç›®
        allExpensesCache.forEach(exp => {
            const splitCount = exp.splitBy.length;
            const perPersonShare = exp.amount / splitCount;
            const payer = exp.payer;
            const settledList = exp.settledMembers || []; // é˜²å‘†

            exp.splitBy.forEach(debtor => {
                // å¦‚æœæ˜¯è‡ªå·±ä»˜çš„ï¼Œæˆ–è€…é€™å€‹äººå·²ç¶“é‚„éŒ¢äº†ï¼Œå°±è·³é
                if (debtor === payer || settledList.includes(debtor)) return;

                // ç´¯åŠ å‚µå‹™
                if (!debts[debtor][payer]) debts[debtor][payer] = 0;
                debts[debtor][payer] += perPersonShare;
            });
        });

        // 3. é¡¯ç¤ºèˆ‡ã€Œæˆ‘ã€æœ‰é—œçš„çµç®—ä»‹é¢
        const list = document.getElementById('settlement-list');
        list.innerHTML = '';
        const myUid = currentUser.uid;

        currentGroupMembers.forEach(member => {
            if (member.uid === myUid) return; // ä¸ç”¨è·Ÿè‡ªå·±çµç®—

            // è¨ˆç®—æˆ‘æ¬ ä»–å¤šå°‘
            let iOweHim = debts[myUid][member.uid] || 0;
            // è¨ˆç®—ä»–æ¬ æˆ‘å¤šå°‘
            let heOwesMe = debts[member.uid] ? (debts[member.uid][myUid] || 0) : 0;

            // äº’ç›¸æŠµéŠ· (Netting)
            let netAmount = iOweHim - heOwesMe; 
            // netAmount > 0 : æˆ‘é‚„è¦çµ¦ä»–éŒ¢
            // netAmount < 0 : ä»–è¦çµ¦æˆ‘éŒ¢ (çµ•å°å€¼)
            // netAmount = 0 : äº’ä¸ç›¸æ¬ 

            let cardClass = 'debt-even';
            let text = `èˆ‡ ${member.name} äº’ä¸ç›¸æ¬ `;
            let buttonHtml = '';

            if (netAmount > 1) { // æˆ‘æ¬ ä»–
                cardClass = 'debt-owe';
                text = `ä½ æ¬  ${member.name}`;
                buttonHtml = `<button class="btn-outline" style="background:white; color:#ff5252; width:auto; margin:0;" onclick="settleUp('${member.uid}', 'pay')">é‚„æ¬¾ $${Math.round(netAmount)}</button>`;
            } else if (netAmount < -1) { // ä»–æ¬ æˆ‘
                cardClass = 'debt-get';
                text = `${member.name} æ¬ ä½ `;
                buttonHtml = `<button class="btn-outline" style="background:white; color:#4caf50; width:auto; margin:0;" onclick="settleUp('${member.uid}', 'receive')">ç¢ºèªæ”¶æ¬¾ $${Math.round(Math.abs(netAmount))}</button>`;
            }

            const div = document.createElement('div');
            div.className = `debt-card ${cardClass}`;
            div.innerHTML = `
                <div>
                    <div style="font-size:14px; opacity:0.9;">${text}</div>
                    <div class="debt-amount">$${Math.round(Math.abs(netAmount))}</div>
                </div>
                ${buttonHtml}
            `;
            list.appendChild(div);
        });
    }

    // --- ğŸŒŸ çµæ¸…å‹•ä½œ (å¯«å…¥è³‡æ–™åº«) ---
    // targetUid: å°æ–¹ID, type: 'pay' (æˆ‘é‚„éŒ¢) æˆ– 'receive' (æˆ‘æ”¶æ¬¾)
    window.settleUp = async (targetUid, type) => {
        if (!confirm('ç¢ºå®šè¦é€²è¡Œçµæ¸…å—ï¼Ÿé€™å°‡æœƒæ›´æ–°æ‰€æœ‰ç›¸é—œå¸³ç›®çš„ç‹€æ…‹ã€‚')) return;

        const myUid = currentUser.uid;
        // æ‰¾å‡ºéœ€è¦æ›´æ–°çš„å¸³å–® (Batch Update)
        const batch = writeBatch(db);
        let count = 0;

        allExpensesCache.forEach(exp => {
            const expRef = doc(db, "expenses", exp.id);
            const settledList = exp.settledMembers || [];

            // æƒ…å¢ƒ 1: æˆ‘é‚„å°æ–¹éŒ¢ (æˆ‘æ˜¯ debtor, å°æ–¹æ˜¯ payer, æˆ‘é‚„æ²’é‚„)
            if (type === 'pay') {
                if (exp.payer === targetUid && exp.splitBy.includes(myUid) && !settledList.includes(myUid)) {
                    batch.update(expRef, { settledMembers: arrayUnion(myUid) });
                    count++;
                }
            }
            
            // æƒ…å¢ƒ 2: å°æ–¹é‚„æˆ‘éŒ¢ (æˆ‘æ˜¯ payer, å°æ–¹æ˜¯ debtor, å°æ–¹é‚„æ²’é‚„)
            if (type === 'receive') {
                if (exp.payer === myUid && exp.splitBy.includes(targetUid) && !settledList.includes(targetUid)) {
                    batch.update(expRef, { settledMembers: arrayUnion(targetUid) });
                    count++;
                }
            }
        });

        if (count > 0) {
            await batch.commit();
            alert(`çµæ¸…å®Œæˆï¼æ›´æ–°äº† ${count} ç­†å¸³ç›®ã€‚`);
            // UI æœƒé€é onSnapshot è‡ªå‹•æ›´æ–°
        } else {
            alert('æ²’æœ‰éœ€è¦æ›´æ–°çš„å¸³ç›® (å¯èƒ½å‰›å¥½è¢«å…¶ä»–äººæ›´æ–°äº†)');
        }
    };

</script>
</body>
</html>