<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠåˆ†å¸³ V8 (ä»‹é¢å„ªåŒ–ç‰ˆ)</title>
    <style>
        /* --- åŸºç¤æ¨£å¼ --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f5f5f5; margin: 0; padding: 0; color: #333; }
        .container { max-width: 600px; margin: 0 auto; min-height: 100vh; background: #fff; position: relative; padding-bottom: 80px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        /* --- Header (ä¿®æ­£æ¨™é¡Œç›´ç«‹å•é¡Œ) --- */
        header { 
            background: #2196F3; 
            color: white; 
            padding: 15px; 
            display: flex; 
            align-items: center; 
            /* âŒ ç§»é™¤ justify-content: space-between; æ”¹ç”¨ flex-grow æ§åˆ¶ */
            position: sticky; 
            top: 0; 
            z-index: 100; 
            height: 60px; 
            box-sizing: border-box;
            overflow: hidden; /* é˜²æ­¢æ•´å€‹ Header è¢«æ’é–‹ */
        }
        header h2 { 
            margin: 0; 
            font-size: 18px; 
            display: flex; 
            align-items: center; 
            overflow: hidden; 
            flex-grow: 1; /* âœ… è®“æ¨™é¡Œä½”æ“šã€Œå‰©é¤˜ã€ç©ºé–“ */
            min-width: 0; /* é—œéµï¼šå…è¨±æ¨™é¡Œç¸®å°ï¼Œæ‰ä¸æœƒæ“ å‡ºå³é‚ŠæŒ‰éˆ• */
            margin-right: 10px; /* èˆ‡å³é‚ŠæŒ‰éˆ•ä¿æŒè·é›¢ */
        }
        #title-text {
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
            display: block; /* âœ… æ”¹å› block æ¯”è¼ƒç©©å®š */
            /* ç§»é™¤ flex: 1ï¼Œé¿å…åœ¨æŸäº›ç€è¦½å™¨è¨ˆç®—éŒ¯èª¤ */
        }
        /* âœ¨ æ–°å¢é€™å€‹ class ä¾†æ§åˆ¶å³é‚ŠæŒ‰éˆ•å€å¡Š */
        .header-actions {
            display: flex; 
            gap: 10px; 
            align-items: center;
            flex-shrink: 0; /* â›”ï¸ é—œéµï¼šçµ•å°ç¦æ­¢æŒ‰éˆ•å€å¡Šè¢«å£“ç¸®æˆ–æ“ å‡ºç•«é¢ */
        }
        .header-btn { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); border-radius: 4px; padding: 5px 12px; color: white; font-size: 14px; cursor: pointer; text-decoration: none; white-space: nowrap; }
        .icon-btn { background: none; border: none; cursor: pointer; font-size: 16px; padding: 0 8px; flex-shrink: 0; margin-left: 5px;}
        .hidden { display: none !important; }

        /* --- View Control --- */
        .view-section { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- UI Elements --- */
        .card { background: white; border: 1px solid #eee; border-radius: 8px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: relative; }
        input, select, button { width: 100%; box-sizing: border-box; padding: 12px; margin-bottom: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; }
        button { cursor: pointer; border: none; font-weight: bold; transition: 0.2s; }
        
        .btn-primary { background: #2196F3; color: white; }
        .btn-outline { background: white; border: 1px solid #2196F3; color: #2196F3; }
        .btn-danger { background: #ffebee; border: 1px solid #ef5350; color: #ef5350; margin-top: 10px; }
        .btn-back { background: #607d8b; color: white; margin-bottom: 15px; width: auto; padding: 8px 15px; font-size: 14px;}

        /* --- Group Card (æ–°ç‰ˆï¼šå·¦å³åˆ†é›¢è¨­è¨ˆ) --- */
        .group-card-row {
            display: flex; 
            align-items: stretch; /* ç­‰é«˜ */
            background: white; 
            border: 1px solid #eee; 
            border-radius: 8px; 
            margin-bottom: 15px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); 
            overflow: hidden; /* ç¢ºä¿åœ“è§’ */
        }
        .group-info-area {
            flex: 1; /* ä½”æ“šå¤§éƒ¨åˆ†ç©ºé–“ */
            padding: 15px;
            cursor: pointer;
            border-right: 1px solid #f0f0f0; /* åˆ†éš”ç·š */
        }
        .group-info-area:active { background-color: #f9f9f9; }
        
        .group-delete-area {
            width: 50px; /* å›ºå®šå¯¬åº¦ */
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fafafa;
            cursor: pointer;
            color: #ccc;
            font-size: 18px;
            transition: all 0.2s;
        }
        .group-delete-area:hover {
            background: #ffebee;
            color: #ef5350;
        }

        /* --- Lists --- */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; color: white; margin-left: 5px; }
        .bg-cash { background: #4caf50; }
        .bg-card { background: #ff9800; }

        /* --- Progress Bar --- */
        .progress-bar-bg { width: 100px; height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .progress-bar-fill { height: 100%; background: #4caf50; transition: width 0.3s; }

        /* --- Debt Cards --- */
        .debt-card { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-radius: 8px; margin-bottom: 10px; color: white; }
        .debt-owe { background-color: #ff5252; } 
        .debt-get { background-color: #4caf50; } 
        .debt-action-btn { background: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; margin-left: 10px; }

        /* --- Checkbox & Layout --- */
        .settle-row { display: flex; align-items: center; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid #eee; }
        .settle-check { transform: scale(1.5); width: auto; margin: 0; cursor: pointer; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-top: 1px solid #ddd; display: flex; justify-content: space-around; padding: 10px 0; max-width: 600px; margin: 0 auto; z-index: 99; }
        .nav-item { border: none; background: none; font-size: 12px; color: #888; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: #2196F3; font-weight: bold; }
        .nav-icon { font-size: 20px; margin-bottom: 2px; }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .checkbox-label { background: #f0f0f0; padding: 8px 12px; border-radius: 20px; display: flex; align-items: center; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <header id="app-header">
        <h2 id="page-title">
            <span id="title-text">æ—…è²»åˆ†å¸³</span>
            <button id="btn-edit-group-name" class="icon-btn hidden" onclick="renameGroup()">âœï¸</button>
        </h2>
        <div class="header-actions">
            <button id="btn-settings" class="header-btn hidden">âš™ï¸ è¨­å®š</button>
            <button id="btn-logout" class="header-btn hidden">ç™»å‡º</button>
        </div>
    </header>

    <div id="view-login" class="view-section active">
        <div style="text-align: center; margin-top: 50px;">
            <h1>âœˆï¸</h1>
            <h2>åˆ†å¸³ç¥å™¨ V8</h2>
            <button id="btn-login" class="btn-primary">Google ç™»å…¥</button>
        </div>
    </div>

    <div id="view-profile" class="view-section">
        <div class="card">
            <h4>ğŸ‘‹ è¨­å®šå€‹äººæš±ç¨±</h4>
            <p style="color:#666; font-size:14px;">é€™æ˜¯é¡¯ç¤ºåœ¨åˆ†å¸³è¡¨å–®ä¸Šçš„åå­—</p>
            <input type="text" id="profile-name-input" placeholder="ä¾‹å¦‚ï¼šå¸¥æ°£å°æ˜">
            <button id="btn-save-profile" class="btn-primary">å„²å­˜è®Šæ›´</button>
            <button onclick="showView('view-groups')" class="btn-outline" style="margin-top:10px;">å–æ¶ˆè¿”å›</button>
        </div>
    </div>

    <div id="view-groups" class="view-section">
        <div class="card">
            <h4>å»ºç«‹æ–°è¡Œç¨‹</h4>
            <input type="text" id="new-group-name" placeholder="åç¨± (ä¾‹: æ—¥æœ¬è¡Œ)">
            <button id="btn-create-group" class="btn-primary">å»ºç«‹</button>
        </div>
        <div class="card">
            <h4>åŠ å…¥è¡Œç¨‹</h4>
            <input type="text" id="join-group-id" placeholder="ç¾¤çµ„ ID">
            <button id="btn-join-group" class="btn-outline">åŠ å…¥</button>
        </div>
        <h4 style="margin: 20px 0 10px;">æˆ‘çš„ç¾¤çµ„</h4>
        <div id="my-groups-list"></div>
    </div>

    <div id="view-dashboard" class="view-section">
        
        <div id="tab-add" class="tab-content">
            <div class="card">
                <label>é‡‘é¡</label>
                <input type="number" id="expense-amount" placeholder="0">
                <label>é …ç›®</label>
                <input type="text" id="expense-note" placeholder="ä¾‹å¦‚ï¼šåˆé¤">
                <div style="display: flex; gap: 10px;">
                    <div style="flex:1">
                        <label>æ–¹å¼</label>
                        <select id="expense-method">
                            <option value="cash">ğŸ’µ ç¾é‡‘</option>
                            <option value="card">ğŸ’³ åˆ·å¡</option>
                        </select>
                    </div>
                    <div style="flex:1">
                        <label>ä»˜æ¬¾äºº</label>
                        <select id="payer-select"></select>
                    </div>
                </div>
                <label>åˆ†æ“”äºº</label>
                <div id="split-members-container" class="checkbox-group"></div>
                <br>
                <button id="btn-submit-expense" class="btn-primary">ç¢ºèªè¨˜å¸³</button>
            </div>
        </div>

        <div id="tab-unsettled" class="tab-content" style="display: none;">
            <div class="card" style="background:#fff3e0; border:1px solid #ffe0b2; padding:10px;">
                <small>â„¹ï¸ é»æ“Šé …ç›®å¯ç·¨è¼¯é‚„æ¬¾æˆ–åˆªé™¤</small>
            </div>
            <div id="unsettled-list"></div>
        </div>

        <div id="tab-matrix" class="tab-content" style="display: none;">
            <div style="text-align: center; margin-bottom: 15px;">
                <h3>çµç®—ä¸­å¿ƒ</h3>
                <p style="color:#666; font-size:13px;">è‡ªå‹•è¨ˆç®—äº’ç›¸æŠµéŠ·å¾Œçš„é‡‘é¡</p>
            </div>
            <div id="matrix-list"></div>
        </div>

        <div id="tab-history" class="tab-content" style="display: none;">
            <div id="history-list"></div>
        </div>

        <div class="bottom-nav">
            <button class="nav-item active" onclick="switchTab('tab-add', this)">
                <span class="nav-icon">â•</span>è¨˜å¸³
            </button>
            <button class="nav-item" onclick="switchTab('tab-unsettled', this)">
                <span class="nav-icon">ğŸ“</span>æ˜ç´°
            </button>
            <button class="nav-item" onclick="switchTab('tab-matrix', this)">
                <span class="nav-icon">ğŸ’°</span>çµç®—
            </button>
            <button class="nav-item" onclick="switchTab('tab-history', this)">
                <span class="nav-icon">ğŸ“œ</span>æ­·å²
            </button>
            <button class="nav-item" onclick="goBackToGroups()">
                <span class="nav-icon">ğŸ”™</span>æ›åœ˜
            </button>
        </div>
    </div>

    <div id="view-detail" class="view-section">
        <button onclick="closeDetail()" class="btn-back">â¬… è¿”å›åˆ—è¡¨</button>
        <div class="card">
            <h2 id="detail-amount" style="color:#2196F3; margin:0;">$0</h2>
            <h4 id="detail-note" style="margin:5px 0;">é …ç›®</h4>
            <p id="detail-payer" style="color:#666; font-size:14px;">ç”±...æ”¯ä»˜</p>
        </div>
        <div class="card">
            <h4>å€‹åˆ¥çµç®—</h4>
            <div id="detail-members-list"></div>
        </div>
        
        <button onclick="deleteCurrentExpense()" class="btn-danger">ğŸ—‘ï¸ åˆªé™¤é€™ç­†å¸³ç›®</button>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, getDoc, setDoc, updateDoc, deleteDoc, arrayUnion, arrayRemove, onSnapshot, query, where, orderBy, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // âš ï¸âš ï¸âš ï¸ è«‹åœ¨æ­¤æ›¿æ›ä½ çš„ Firebase Config âš ï¸âš ï¸âš ï¸
    const firebaseConfig = {
            apiKey: "AIzaSyDQFDcA3OB0y-KZCDf9QzQLFZm8w3oVqyg",
            authDomain: "trip-web-82474.firebaseapp.com",
            projectId: "trip-web-82474",
            storageBucket: "trip-web-82474.firebasestorage.app",
            messagingSenderId: "900625161560",
            appId: "1:900625161560:web:370f4dcb647f44fc1c992d",
            measurementId: "G-PHVPTW4CPL"
        };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;
    let currentGroupId = null;
    let currentGroupName = '';
    let currentGroupMembers = [];
    let currentDetailDocId = null; 
    let allExpensesCache = [];

    // --- Logout & Settings ---
    document.getElementById('btn-logout').addEventListener('click', () => {
        if(confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) signOut(auth).then(() => location.reload());
    });
    
    document.getElementById('btn-settings').addEventListener('click', () => {
        document.getElementById('profile-name-input').value = currentUser.displayName || '';
        showView('view-profile');
    });

    // --- Navigation (ä¿®å¾©æ¨™é¡Œå¡ä½å•é¡Œ) ---
    function showView(viewId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById(viewId).classList.add('active');
        
        const isLogin = (viewId === 'view-login');
        const isDash = (viewId === 'view-dashboard');
        
        document.getElementById('btn-logout').classList.toggle('hidden', isLogin);
        document.getElementById('btn-settings').classList.toggle('hidden', isLogin || isDash); 
        document.getElementById('btn-edit-group-name').classList.toggle('hidden', !isDash);

        // æ¨™é¡Œé¡¯ç¤ºé‚è¼¯
        const rootViews = ['view-login', 'view-profile', 'view-groups'];
        if (rootViews.includes(viewId)) {
            document.getElementById('title-text').innerText = 'æ—…è²»åˆ†å¸³';
            currentGroupName = ''; 
        } else if (currentGroupName) {
            document.getElementById('title-text').innerText = currentGroupName;
        }

        const bottomNav = document.querySelector('.bottom-nav');
        if (viewId === 'view-detail') bottomNav.style.display = 'none';
        else if (viewId === 'view-dashboard') bottomNav.style.display = 'flex';
    }

    window.switchTab = (tabId, btnElement) => {
        document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
        document.getElementById(tabId).style.display = 'block';
        document.querySelectorAll('.bottom-nav .nav-item').forEach(btn => btn.classList.remove('active'));
        if(btnElement) btnElement.classList.add('active');
        if(tabId === 'tab-matrix') calculateMatrix();
    };

    window.goBackToGroups = () => { currentGroupId = null; showView('view-groups'); };
    window.closeDetail = () => { currentDetailDocId = null; showView('view-dashboard'); };

    // --- Auth ---
    document.getElementById('btn-login').addEventListener('click', () => signInWithPopup(auth, new GoogleAuthProvider()).catch(alert));

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            const userDoc = await getDoc(doc(db, "users", user.uid));
            if (userDoc.exists() && userDoc.data().displayName) {
                currentUser.displayName = userDoc.data().displayName;
                loadMyGroups();
                showView('view-groups');
            } else { showView('view-profile'); }
        } else { showView('view-login'); }
    });

    // --- Save Profile ---
    document.getElementById('btn-save-profile').addEventListener('click', async () => {
        const name = document.getElementById('profile-name-input').value.trim();
        if (!name) return;
        await setDoc(doc(db, "users", currentUser.uid), { displayName: name, email: currentUser.email }, { merge: true });
        
        currentUser.displayName = name; 
        alert('æš±ç¨±æ›´æ–°æˆåŠŸï¼');
        
        loadMyGroups();
        showView('view-groups');
    });

    // --- Group Logic ---
    document.getElementById('btn-create-group').addEventListener('click', async () => {
        const name = document.getElementById('new-group-name').value.trim();
        if (!name) return;
        await addDoc(collection(db, "groups"), {
            name: name,
            members: [{ uid: currentUser.uid, name: currentUser.displayName }],
            createdAt: new Date()
        });
        loadMyGroups();
    });

    document.getElementById('btn-join-group').addEventListener('click', async () => {
        const groupId = document.getElementById('join-group-id').value.trim();
        if (!groupId) return;
        const groupRef = doc(db, "groups", groupId);
        const snap = await getDoc(groupRef);
        if (snap.exists()) {
            const members = snap.data().members || [];
            if (!members.some(m => m.uid === currentUser.uid)) {
                await updateDoc(groupRef, { members: arrayUnion({ uid: currentUser.uid, name: currentUser.displayName }) });
            }
            loadMyGroups();
        } else { alert('æ‰¾ä¸åˆ°ç¾¤çµ„'); }
    });

    // --- List Groups (æ”¹é€²ç‰ˆï¼šå·¦å³åˆ†é›¢çµæ§‹) ---
    async function loadMyGroups() {
        const list = document.getElementById('my-groups-list');
        list.innerHTML = 'è¼‰å…¥ä¸­...';
        const q = query(collection(db, "groups"), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);
        list.innerHTML = '';
        
        querySnapshot.forEach((docSnap) => {
            const data = docSnap.data();
            if (data.members.some(m => m.uid === currentUser.uid)) {
                // å»ºç«‹å¤–å±¤å®¹å™¨
                const row = document.createElement('div');
                row.className = 'group-card-row';

                // å·¦å´ï¼šé»æ“Šé€²å…¥ç¾¤çµ„
                const infoArea = document.createElement('div');
                infoArea.className = 'group-info-area';
                infoArea.innerHTML = `<strong>${data.name}</strong> <br> <small>ID: ${docSnap.id}</small>`;
                infoArea.onclick = () => enterGroup(docSnap.id, data.name);

                // å³å´ï¼šåˆªé™¤æŒ‰éˆ•
                const deleteArea = document.createElement('div');
                deleteArea.className = 'group-delete-area';
                deleteArea.innerHTML = 'ğŸ—‘ï¸'; // åƒåœ¾æ¡¶åœ–ç¤º
                deleteArea.onclick = () => deleteGroup(docSnap.id, data.name);

                row.appendChild(infoArea);
                row.appendChild(deleteArea);
                list.appendChild(row);
            }
        });
    }

    window.deleteGroup = async (groupId, groupName) => {
        const confirmName = prompt(`âš ï¸ å±éšªå‹•ä½œï¼\né€™å°‡åˆªé™¤æ•´å€‹ç¾¤çµ„ï¼Œæ‰€æœ‰äººçš„è³‡æ–™éƒ½æœƒæ¶ˆå¤±ã€‚\nè«‹è¼¸å…¥ç¾¤çµ„åç¨± "${groupName}" ä»¥ç¢ºèªåˆªé™¤ï¼š`);
        if (confirmName === groupName) {
            await deleteDoc(doc(db, "groups", groupId));
            alert('ç¾¤çµ„å·²åˆªé™¤');
            loadMyGroups();
        } else if (confirmName !== null) {
            alert('åç¨±è¼¸å…¥éŒ¯èª¤ï¼Œå–æ¶ˆåˆªé™¤');
        }
    };

    // --- Enter Group ---
    function enterGroup(groupId, groupName) {
        currentGroupId = groupId;
        currentGroupName = groupName;
        document.getElementById('title-text').innerText = groupName; 
        showView('view-dashboard');
        switchTab('tab-add');

        onSnapshot(doc(db, "groups", groupId), (docSnap) => {
            if(docSnap.exists()) {
                const data = docSnap.data();
                currentGroupMembers = data.members;
                currentGroupName = data.name;
                document.getElementById('title-text').innerText = data.name;
                renderExpenseForm(currentGroupMembers);
            } else {
                alert('æ­¤ç¾¤çµ„å·²è¢«åˆªé™¤');
                goBackToGroups();
            }
        });

        const expenseQ = query(collection(db, "expenses"), where("groupId", "==", groupId), orderBy("timestamp", "desc"));
        onSnapshot(expenseQ, (snapshot) => {
            allExpensesCache = [];
            const unsettledList = document.getElementById('unsettled-list');
            const historyList = document.getElementById('history-list');
            
            unsettledList.innerHTML = '';
            historyList.innerHTML = '';
            let unsettledCount = 0;

            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                data.id = docSnap.id;
                allExpensesCache.push(data);

                const settledMembers = data.settledMembers || [];
                const totalDebtors = data.splitBy.length;
                const isFullySettled = (settledMembers.length === totalDebtors && totalDebtors > 0);

                const payerName = currentGroupMembers.find(m => m.uid === data.payer)?.name || 'æœªçŸ¥';
                const methodBadge = data.method === 'card' ? '<span class="badge bg-card">å¡</span>' : '<span class="badge bg-cash">ç¾</span>';
                const dateStr = data.timestamp?.seconds ? new Date(data.timestamp.seconds * 1000).toLocaleDateString() : '';
                const progressPercent = totalDebtors > 0 ? (settledMembers.length / totalDebtors) * 100 : 0;

                const itemHtml = `
                    <div class="list-item" onclick="openDetail('${data.id}')">
                        <div style="flex:1">
                            <div style="font-weight:bold;">${data.note} ${methodBadge}</div>
                            <div style="font-size:12px; color:#666;">${payerName} ä»˜æ¬¾ (${dateStr})</div>
                            ${!isFullySettled ? `
                            <div class="progress-bar-bg">
                                <div class="progress-bar-fill" style="width: ${progressPercent}%"></div>
                            </div>
                            <div style="font-size:10px; color:#888;">å·²çµæ¸… ${settledMembers.length}/${totalDebtors} äºº</div>
                            ` : ''}
                        </div>
                        <div style="font-weight:bold; color: #2196F3;">$${data.amount}</div>
                    </div>`;

                if (isFullySettled) historyList.innerHTML += itemHtml;
                else {
                    unsettledList.innerHTML += itemHtml;
                    unsettledCount++;
                }

                if (currentDetailDocId === data.id) renderDetailView(data);
            });

            if (unsettledCount === 0) unsettledList.innerHTML = '<p style="text-align:center;color:#999;margin-top:20px">ğŸ‰ æ²’æœ‰æœªçµæ¸…å¸³ç›®</p>';
            if(document.getElementById('tab-matrix').style.display === 'block') calculateMatrix();
        });
    }

    // --- Rename Group ---
    window.renameGroup = async () => {
        const newName = prompt("è«‹è¼¸å…¥æ–°çš„ç¾¤çµ„åç¨±ï¼š", currentGroupName);
        if (newName && newName.trim() !== "") {
            await updateDoc(doc(db, "groups", currentGroupId), { name: newName });
        }
    };

    function renderExpenseForm(members) {
        const payerSelect = document.getElementById('payer-select');
        const splitContainer = document.getElementById('split-members-container');
        payerSelect.innerHTML = '';
        splitContainer.innerHTML = '';
        members.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m.uid;
            opt.innerText = m.name;
            if(m.uid === currentUser.uid) opt.selected = true;
            payerSelect.appendChild(opt);

            const label = document.createElement('label');
            label.className = 'checkbox-label';
            label.innerHTML = `<input type="checkbox" value="${m.uid}" checked> ${m.name}`;
            splitContainer.appendChild(label);
        });
    }

    document.getElementById('btn-submit-expense').addEventListener('click', async () => {
        const amount = Number(document.getElementById('expense-amount').value);
        const note = document.getElementById('expense-note').value;
        const method = document.getElementById('expense-method').value;
        const payer = document.getElementById('payer-select').value;
        const checkboxes = document.querySelectorAll('#split-members-container input:checked');
        const splitBy = Array.from(checkboxes).map(cb => cb.value);

        if(!amount || !note || splitBy.length === 0) return alert('è«‹å¡«å¯«å®Œæ•´');

        let initialSettled = [];
        if (splitBy.includes(payer)) initialSettled.push(payer);

        await addDoc(collection(db, "expenses"), {
            groupId: currentGroupId,
            amount, note, method, payer, splitBy,
            settledMembers: initialSettled,
            timestamp: new Date()
        });
        
        document.getElementById('expense-amount').value = '';
        document.getElementById('expense-note').value = '';
        alert('è¨˜å¸³æˆåŠŸï¼');
    });

    // --- Detail View ---
    window.openDetail = async (docId) => {
        currentDetailDocId = docId;
        showView('view-detail');
        const docSnap = await getDoc(doc(db, "expenses", docId));
        if (docSnap.exists()) renderDetailView({ ...docSnap.data(), id: docSnap.id });
    };

    window.deleteCurrentExpense = async () => {
        if(confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†å¸³ç›®å—ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸã€‚')) {
            await deleteDoc(doc(db, "expenses", currentDetailDocId));
            alert('å·²åˆªé™¤');
            closeDetail();
        }
    };

    function renderDetailView(data) {
        const payerName = currentGroupMembers.find(m => m.uid === data.payer)?.name || 'æœªçŸ¥';
        document.getElementById('detail-amount').innerText = `$${data.amount}`;
        document.getElementById('detail-note').innerText = data.note;
        document.getElementById('detail-payer').innerText = `ç”± ${payerName} å…ˆå¢Šä»˜`;

        const listContainer = document.getElementById('detail-members-list');
        listContainer.innerHTML = '';
        const share = Math.round(data.amount / data.splitBy.length);
        const settledSet = new Set(data.settledMembers || []);

        data.splitBy.forEach(memberUid => {
            const memberName = currentGroupMembers.find(m => m.uid === memberUid)?.name || 'æœªçŸ¥';
            const isSettled = settledSet.has(memberUid);
            const isPayer = (memberUid === data.payer);

            let checkboxHtml = '';
            if (isPayer) checkboxHtml = `<span style="font-size:12px; color:#888;">ä»˜æ¬¾äºº</span>`;
            else checkboxHtml = `<input type="checkbox" class="settle-check" onchange="toggleMemberSettlement('${data.id}', '${memberUid}', this.checked)" ${isSettled ? 'checked' : ''}>`;

            const div = document.createElement('div');
            div.className = 'settle-row';
            div.innerHTML = `
                <div>
                    <span style="font-size:16px;">${memberName}</span>
                    <div style="font-size:12px; color:#888;">æ‡‰ä»˜ $${share}</div>
                </div>
                <div>${checkboxHtml}</div>
            `;
            listContainer.appendChild(div);
        });
    }

    window.toggleMemberSettlement = async (docId, memberUid, isChecked) => {
        const expRef = doc(db, "expenses", docId);
        if (isChecked) await updateDoc(expRef, { settledMembers: arrayUnion(memberUid) });
        else await updateDoc(expRef, { settledMembers: arrayRemove(memberUid) });
    };

    // --- Matrix Calculation ---
    function calculateMatrix() {
        let debts = {};
        currentGroupMembers.forEach(m => debts[m.uid] = {});

        allExpensesCache.forEach(exp => {
            const splitCount = exp.splitBy.length;
            const perPersonShare = exp.amount / splitCount;
            const payer = exp.payer;
            const settledList = exp.settledMembers || [];

            exp.splitBy.forEach(debtor => {
                if (debtor !== payer && !settledList.includes(debtor)) {
                    if (!debts[debtor][payer]) debts[debtor][payer] = 0;
                    debts[debtor][payer] += perPersonShare;
                }
            });
        });

        const list = document.getElementById('matrix-list');
        list.innerHTML = '';
        const myUid = currentUser.uid;

        currentGroupMembers.forEach(member => {
            if (member.uid === myUid) return;

            let iOweHim = debts[myUid][member.uid] || 0;
            let heOwesMe = debts[member.uid] ? (debts[member.uid][myUid] || 0) : 0;
            let netAmount = iOweHim - heOwesMe;

            if (Math.abs(netAmount) < 1) return;

            let cardClass = 'debt-even';
            let text = '';
            let btnText = '';
            let btnAction = '';
            let btnColor = '';

            if (netAmount > 0) {
                cardClass = 'debt-owe';
                text = `ä½ æ¬  ${member.name}`;
                btnText = `é‚„æ¬¾ $${Math.round(netAmount)}`;
                btnAction = 'pay';
                btnColor = '#ff5252';
            } else {
                cardClass = 'debt-get';
                text = `${member.name} æ¬ ä½ `;
                btnText = `æ”¶æ¬¾ $${Math.round(Math.abs(netAmount))}`;
                btnAction = 'receive';
                btnColor = '#4caf50';
            }

            const div = document.createElement('div');
            div.className = `debt-card ${cardClass}`;
            div.innerHTML = `
                <div>
                    <div style="font-size:14px; opacity:0.9;">${text}</div>
                    <div style="font-size:20px; font-weight:bold;">$${Math.round(Math.abs(netAmount))}</div>
                </div>
                <button class="debt-action-btn" style="color:${btnColor}" onclick="settleTotal('${member.uid}', '${btnAction}')">
                    ${btnText}
                </button>
            `;
            list.appendChild(div);
        });

        if (list.innerHTML === '') {
            list.innerHTML = '<p style="text-align:center;color:#999;">ç›®å‰æ²’æœ‰éœ€è¦çµç®—çš„æ¬¾é …</p>';
        }
    }

    window.settleTotal = async (targetUid, type) => {
        if (!confirm('ç¢ºå®šè¦é€²è¡Œçµæ¸…å—ï¼Ÿé€™å°‡æœƒæŠŠä½ å€‘ä¹‹é–“ã€Œæ‰€æœ‰æœªçµæ¸…ã€çš„ç´°é …å…¨éƒ¨å‹¾é¸èµ·ä¾†ã€‚')) return;

        const myUid = currentUser.uid;
        const batch = writeBatch(db);
        let count = 0;

        allExpensesCache.forEach(exp => {
            const expRef = doc(db, "expenses", exp.id);
            const settledList = exp.settledMembers || [];

            if (type === 'pay') {
                if (exp.payer === targetUid && exp.splitBy.includes(myUid) && !settledList.includes(myUid)) {
                    batch.update(expRef, { settledMembers: arrayUnion(myUid) });
                    count++;
                }
                if (exp.payer === myUid && exp.splitBy.includes(targetUid) && !settledList.includes(targetUid)) {
                     batch.update(expRef, { settledMembers: arrayUnion(targetUid) });
                     count++;
                }
            }
            
            if (type === 'receive') {
                if (exp.payer === myUid && exp.splitBy.includes(targetUid) && !settledList.includes(targetUid)) {
                    batch.update(expRef, { settledMembers: arrayUnion(targetUid) });
                    count++;
                }
                if (exp.payer === targetUid && exp.splitBy.includes(myUid) && !settledList.includes(myUid)) {
                    batch.update(expRef, { settledMembers: arrayUnion(myUid) });
                    count++;
                }
            }
        });

        if (count > 0) {
            await batch.commit();
            alert(`çµç®—å®Œæˆï¼å·²è‡ªå‹•å‹¾é¸ ${count} ç­†ç›¸é—œå¸³ç›®ã€‚`);
        } else {
            alert('ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
    };
</script>
</body>
</html>