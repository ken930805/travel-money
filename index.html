<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…éŠåˆ†å¸³å°å¹«æ‰‹</title>
    <style>
        /* ç°¡å–®çš„æ‰‹æ©Ÿç‰ˆå‹ CSS */
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .hidden { display: none; }
        .card { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin-top: 5px;}
        input, select { padding: 8px; font-size: 16px; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        .member-checkbox { display: flex; align-items: center; margin-bottom: 5px; }
        .member-checkbox input { width: auto; margin-right: 10px; }
    </style>
</head>
<body>

    <h1>âœˆï¸ æ—…éŠåˆ†å¸³ Web App</h1>

    <div id="login-section">
        <p>è«‹å…ˆç™»å…¥ä»¥é–‹å§‹ä½¿ç”¨</p>
        <button id="btn-login">Google å¸³è™Ÿç™»å…¥</button>
    </div>

    <div id="dashboard-section" class="hidden">
        <h3 id="user-greeting"></h3>
        
        <div class="card">
            <h4>ç¾¤çµ„ç®¡ç†</h4>
            <p>ç›®å‰çš„ç¾¤çµ„ ID: <strong id="current-group-id">å°šæœªåŠ å…¥</strong></p>
            <hr>
            <input type="text" id="new-group-name" placeholder="è¼¸å…¥æ–°ç¾¤çµ„åç¨± (ä¾‹: æ—¥æœ¬è¡Œ)">
            <button id="btn-create-group">å»ºç«‹æ–°ç¾¤çµ„</button>
            <hr>
            <input type="text" id="join-group-id" placeholder="è¼¸å…¥æœ‹å‹çµ¦çš„ç¾¤çµ„ ID">
            <button id="btn-join-group">åŠ å…¥ç¾æœ‰ç¾¤çµ„</button>
        </div>

        <div id="expense-form" class="card hidden">
            <h4>ğŸ’° æ–°å¢ä¸€ç­†æ¶ˆè²»</h4>
            <label>é‡‘é¡</label>
            <input type="number" id="amount" placeholder="å¤šå°‘éŒ¢">
            
            <label>é …ç›®èªªæ˜</label>
            <input type="text" id="note" placeholder="ä¾‹å¦‚ï¼šåˆé¤ã€è»Šç¥¨">

            <label>èª°ä»˜çš„éŒ¢ï¼Ÿ</label>
            <select id="payer-select"></select>

            <label>è¦å¹«èª°ä»˜ (åˆ†éŒ¢çš„äºº)ï¼Ÿ</label>
            <div id="split-members-container">
                </div>

            <button id="btn-submit-expense" style="background-color: #4CAF50; color: white;">é€å‡ºè¨˜å¸³</button>
        </div>
        
        <div id="logs" class="card">
             <h4>æœ€è¿‘ç´€éŒ„</h4>
             <ul id="expense-list"></ul>
        </div>
    </div>

    <script type="module">
        // âš ï¸ è«‹å°‡é€™è£¡æ›¿æ›æˆä½  Firebase å¾Œå°çš„è¨­å®š âš ï¸
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, arrayUnion, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQFDcA3OB0y-KZCDf9QzQLFZm8w3oVqyg",
            authDomain: "trip-web-82474.firebaseapp.com",
            projectId: "trip-web-82474",
            storageBucket: "trip-web-82474.firebasestorage.app",
            messagingSenderId: "900625161560",
            appId: "1:900625161560:web:370f4dcb647f44fc1c992d",
            measurementId: "G-PHVPTW4CPL"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        let currentGroupId = null; // æš«å­˜ç›®å‰æ“ä½œçš„ Group ID

        // --- 1. ç™»å…¥é‚è¼¯ ---
        const btnLogin = document.getElementById('btn-login');
        btnLogin.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(console.error);
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.remove('hidden');
                document.getElementById('user-greeting').innerText = `å“ˆå›‰ï¼Œ${user.displayName}`;
                
                // é€™è£¡ç°¡åŒ–è™•ç†ï¼šå‡è¨­ä½¿ç”¨è€…æœ€å¾Œä¸€æ¬¡åŠ å…¥çš„ç¾¤çµ„å°±æ˜¯ç•¶å‰ç¾¤çµ„
                // å¯¦å‹™ä¸Šä½ æ‡‰è©²å°‡ currentGroupId å­˜åœ¨ localStorage æˆ–è®“ä½¿ç”¨è€…é¸æ“‡
            }
        });

        // --- 2. å»ºç«‹ç¾¤çµ„ ---
        document.getElementById('btn-create-group').addEventListener('click', async () => {
            const name = document.getElementById('new-group-name').value;
            if (!name) return alert('è«‹è¼¸å…¥ç¾¤çµ„åç¨±');

            try {
                // åœ¨ Firestore å»ºç«‹ç¾¤çµ„æ–‡ä»¶
                const docRef = await addDoc(collection(db, "groups"), {
                    name: name,
                    members: [{ uid: currentUser.uid, name: currentUser.displayName }] // åˆå§‹æˆå“¡åªæœ‰è‡ªå·±
                });
                
                currentGroupId = docRef.id;
                updateGroupUI();
                alert(`ç¾¤çµ„å»ºç«‹æˆåŠŸï¼è«‹æŠŠé€™å€‹ ID çµ¦æœ‹å‹ï¼š\n${currentGroupId}`);
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        });

        // --- 3. åŠ å…¥ç¾¤çµ„ ---
        document.getElementById('btn-join-group').addEventListener('click', async () => {
            const groupId = document.getElementById('join-group-id').value.trim();
            if (!groupId) return alert('è«‹è¼¸å…¥ ID');

            const groupRef = doc(db, "groups", groupId);
            const groupSnap = await getDoc(groupRef);

            if (groupSnap.exists()) {
                // å°‡è‡ªå·±åŠ å…¥æˆå“¡åå–®
                await updateDoc(groupRef, {
                    members: arrayUnion({ uid: currentUser.uid, name: currentUser.displayName })
                });
                currentGroupId = groupId;
                updateGroupUI();
                alert('æˆåŠŸåŠ å…¥ç¾¤çµ„ï¼');
            } else {
                alert('æ‰¾ä¸åˆ°é€™å€‹ç¾¤çµ„ ID');
            }
        });

        // --- 4. æ›´æ–°ä»‹é¢ & ç›£è½æˆå“¡ ---
        function updateGroupUI() {
            if (!currentGroupId) return;
            document.getElementById('current-group-id').innerText = currentGroupId;
            document.getElementById('expense-form').classList.remove('hidden');

            // ç›£è½é€™å€‹ç¾¤çµ„çš„è®ŠåŒ– (å¦‚æœæœ‰æ–°æœ‹å‹åŠ å…¥ï¼Œå‹¾é¸åå–®è¦è‡ªå‹•æ›´æ–°)
            onSnapshot(doc(db, "groups", currentGroupId), (doc) => {
                const data = doc.data();
                const members = data.members;
                
                const container = document.getElementById('split-members-container');
                const payerSelect = document.getElementById('payer-select');
                
                container.innerHTML = '';
                payerSelect.innerHTML = '';

                members.forEach(member => {
                    // å»ºç«‹ä»˜æ¬¾äººä¸‹æ‹‰é¸å–®
                    const option = document.createElement('option');
                    option.value = member.uid;
                    option.innerText = member.name;
                    if(member.uid === currentUser.uid) option.selected = true; // é è¨­é¸è‡ªå·±
                    payerSelect.appendChild(option);

                    // å»ºç«‹åˆ†å¸³äººå‹¾é¸æ¡†
                    const wrapper = document.createElement('div');
                    wrapper.className = 'member-checkbox';
                    wrapper.innerHTML = `
                        <input type="checkbox" value="${member.uid}" checked id="chk-${member.uid}">
                        <label for="chk-${member.uid}">${member.name}</label>
                    `;
                    container.appendChild(wrapper);
                });
            });

            // ç›£è½æ¶ˆè²»ç´€éŒ„
            loadExpenses();
        }

        // --- 5. é€å‡ºè¨˜å¸³ ---
        document.getElementById('btn-submit-expense').addEventListener('click', async () => {
            const amount = parseFloat(document.getElementById('amount').value);
            const note = document.getElementById('note').value;
            const payerId = document.getElementById('payer-select').value;
            
            // æ‰¾å‡ºè¢«å‹¾é¸çš„äºº
            const checkboxes = document.querySelectorAll('#split-members-container input[type="checkbox"]:checked');
            const splitMembers = Array.from(checkboxes).map(cb => cb.value);

            if (!amount || splitMembers.length === 0) return alert('è«‹è¼¸å…¥é‡‘é¡ä¸¦è‡³å°‘é¸æ“‡ä¸€äººåˆ†æ”¤');

            await addDoc(collection(db, "expenses"), {
                groupId: currentGroupId,
                payer: payerId,
                amount: amount,
                note: note,
                splitBy: splitMembers,
                timestamp: new Date()
            });

            // æ¸…ç©ºè¡¨å–®
            document.getElementById('amount').value = '';
            document.getElementById('note').value = '';
            alert('è¨˜å¸³æˆåŠŸï¼');
        });

        function loadExpenses() {
             const q = query(collection(db, "expenses"), where("groupId", "==", currentGroupId));
             onSnapshot(q, (snapshot) => {
                const list = document.getElementById('expense-list');
                list.innerHTML = '';
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    const li = document.createElement('li');
                    li.innerText = `${data.note}: ${data.amount}å…ƒ (ç”±...æ”¯ä»˜)`; // é€™è£¡å¯ä»¥å†å„ªåŒ–é¡¯ç¤ºåå­—
                    list.appendChild(li);
                });
             });
        }
    </script>
</body>
</html>